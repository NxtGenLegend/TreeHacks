<!doctype html>
<html>
    <head>
        <title>RTMS Webhook</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 20px auto;
                padding: 20px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            input[type="text"] {
                width: 100%;
                padding: 8px;
                margin-top: 5px;
            }
            button {
                background-color: #0066cc;
                color: white;
                padding: 10px 20px;
                border: none;
                cursor: pointer;
                margin-right: 10px;
            }
            button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }
            button:hover:not(:disabled) {
                background-color: #0052a3;
            }
        </style>
    </head>
    <body>
        <h2>RTMS Webhook Sender</h2>
        <div class="form-group">
            <label>Webhook URL:</label>
            <input
                type="text"
                id="webhookUrl"
                placeholder="Enter webhook URL"
            />
        </div>
        <button onclick="validateWebhook()" id="validateBtn">
            Validate Webhook
        </button>
        <button onclick="sendWebhook()" id="sendBtn" disabled>
            Send Webhook
        </button>
        <button onclick="pauseSession()" id="pauseBtn" disabled>Pause</button>
        <button onclick="resumeSession()" id="resumeBtn" disabled>Resume</button>
        <button onclick="stopSession()" id="stopBtn" disabled>Stop</button>
        <button onclick="endMeeting()" id="endBtn" disabled>End Meeting</button>
        <div id="videoContainer" style="margin-top: 20px; display: none;">
            <video id="meetingVideo" width="640" height="360" autoplay controls></video>
            <audio id="meetingAudio" autoplay></audio>
            <div id="transcript"></div>
        </div>
        <div id="response" style="margin-top: 20px"></div>

        <script>
            let mediaSocket;
            let mediaStream;
            let mediaRecorders = {
                video: null,
                audio: null
            };
            let recognition = null;
            let sessionState = "STOPPED"; // Add session state variable
            const SESSION_STATE_UPDATE = "SESSION_STATE_UPDATE";
            const ACTION_BY_USER = "ACTION_BY_USER";
            const STARTED = "STARTED";
            const PAUSED = "PAUSED";
            const RESUMED = "RESUMED";
            const STOPPED = "STOPPED";


            async function startMediaStream(serverUrl) {
                const video = document.getElementById('meetingVideo');
                const pauseBtn = document.getElementById('pauseBtn');
                const resumeBtn = document.getElementById('resumeBtn');
                const stopBtn = document.getElementById('stopBtn');
                const sendBtn = document.getElementById('sendBtn');

                video.style.display = 'block';
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                stopBtn.disabled = false;
                sendBtn.disabled = true;

                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true,
                        audio: true 
                    });
                    video.srcObject = mediaStream;
                    await video.play();

                    mediaSocket = new WebSocket(`${serverUrl}/all`.replace('https://', 'wss://'));

                    mediaSocket.onopen = () => {
                        console.log('Connected to media server');
                        document.getElementById('videoContainer').style.display = 'block';

                        const videoTrack = mediaStream.getVideoTracks()[0];
                        const videoStream = new MediaStream([videoTrack]);
                        mediaRecorders.video = new MediaRecorder(videoStream, {
                            mimeType: 'video/webm;codecs=vp8'
                        });

                        mediaRecorders.video.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const base64data = reader.result.split(',')[1];
                                    mediaSocket.send(JSON.stringify({
                                        msg_type: "MEDIA_DATA_VIDEO",
                                        content: {
                                            user_id: 0,
                                            data: base64data,
                                            timestamp: Date.now()
                                        }
                                    }));
                                };
                                reader.readAsDataURL(event.data);
                            }
                        };

                        const audioTrack = mediaStream.getAudioTracks()[0];
                        const audioStream = new MediaStream([audioTrack]);
                        mediaRecorders.audio = new MediaRecorder(audioStream, {
                            mimeType: 'audio/webm'
                        });

                        mediaRecorders.audio.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const base64data = reader.result.split(',')[1];
                                    mediaSocket.send(JSON.stringify({
                                        msg_type: "MEDIA_DATA_AUDIO",
                                        content: {
                                            user_id: 0,
                                            data: base64data,
                                            timestamp: Date.now()
                                        }
                                    }));
                                };
                                reader.readAsDataURL(event.data);
                            }
                        };

                        mediaRecorders.video.start(100);
                        mediaRecorders.audio.start(100);

                        //Initialize Speech Recognition
                        recognition = new webkitSpeechRecognition(); // For Chrome, Safari
                        recognition.continuous = true;
                        recognition.interimResults = true;
                        recognition.lang = 'en-US'; // Set your desired language

                        recognition.onresult = (event) => {
                            let transcript = '';
                            for (let i = event.resultIndex; i < event.results.length; ++i) {
                                if (event.results[i].isFinal) {
                                    transcript += event.results[i][0].transcript;
                                }
                            }
                            document.getElementById('transcript').innerText = transcript;

                            // Send transcript data through websocket
                            mediaSocket.send(JSON.stringify({
                                msg_type: "MEDIA_DATA_TRANSCRIPT",
                                content: {
                                    user_id: 0,
                                    data: transcript,
                                    timestamp: Date.now()
                                }
                            }));
                        };

                        recognition.start();
                    };

                    mediaSocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        console.log("Received message:", message.msg_type);

                        if (message.msg_type === "MEDIA_DATA_VIDEO") {
                            const video = document.getElementById('meetingVideo');
                            const blob = new Blob([atob(message.content.data)], { type: 'video/webm;codecs=vp8' });
                            video.src = URL.createObjectURL(blob);
                        } else if (message.msg_type === "MEDIA_DATA_AUDIO") {
                            const audio = document.getElementById('meetingAudio');
                            const blob = new Blob([atob(message.content.data)], { type: 'audio/webm' });
                            audio.src = URL.createObjectURL(blob);
                        }
                    };

                    // Add WebSocket close handler
                    mediaSocket.onclose = () => {
                        console.log('Media connection closed');
                        if (recognition) {
                            recognition.stop();
                        }
                        document.getElementById('sendBtn').disabled = false;
                        document.getElementById('pauseBtn').disabled = true;
                        document.getElementById('resumeBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('endBtn').disabled = true;
                    };

                } catch (err) {
                    console.error("Error accessing media devices:", err);
                }
            }

            async function validateWebhook() {
                const webhookUrl = document.getElementById("webhookUrl").value;
                const responseDiv = document.getElementById("response");
                const sendBtn = document.getElementById("sendBtn");

                try {
                    const response = await fetch("/api/validate-webhook", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ webhookUrl }),
                    });

                    const data = await response.json();
                    if (data.success) {
                        responseDiv.innerHTML = "Webhook validated successfully!";
                        sendBtn.disabled = false;
                    } else {
                        responseDiv.innerHTML = `Validation failed: ${data.error}`;
                        sendBtn.disabled = true;
                    }
                } catch (error) {
                    responseDiv.innerHTML = `Error: ${error.message}`;
                    sendBtn.disabled = true;
                }
            }

            async function sendWebhook() {
                const webhookUrl = document.getElementById("webhookUrl").value;
                const responseDiv = document.getElementById("response");

                try {
                    const response = await fetch("/api/send-webhook", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ webhookUrl }),
                    });

                    const data = await response.json();
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                    if (data.success && data.sent.payload.payload.object.server_urls) {
                        startMediaStream(data.sent.payload.payload.object.server_urls);
                        sessionState = STARTED; // Update session state after successful start
                    }
                } catch (error) {
                    responseDiv.innerHTML = `Error: ${error.message}`;
                }
            }

            function sendSessionStateUpdate(state, stopReason) {
                if (!mediaSocket || mediaSocket.readyState !== WebSocket.OPEN) return; //check connection

                const rmtsSessionId = "xxxxxxxxxx"; // Replace with actual session ID generation
                const timestamp = Date.now();
                const message = {
                    msg_type: SESSION_STATE_UPDATE,
                    rmts_session_id: rmtsSessionId,
                    state: state,
                    stop_reason: stopReason,
                    timestamp: timestamp
                };
                mediaSocket.send(JSON.stringify(message));
            }

            function sendSessionStateUpdate(state, stopReason) {
                if (!mediaSocket) return;
                const message = {
                    msg_type: "SESSION_STATE_UPDATE",
                    rmts_session_id: mediaSocket.rtmsSessionId,
                    state: state,
                    stop_reason: stopReason,
                    timestamp: Date.now()
                };
                mediaSocket.send(JSON.stringify(message));
            }

            function pauseSession() {
                if (!mediaSocket || sessionState === STOPPED) return;
                sessionState = PAUSED;

                if (mediaRecorders.video) mediaRecorders.video.stop();
                if (mediaRecorders.audio) mediaRecorders.audio.stop();
                if (recognition) recognition.stop();

                // Send state update before modifying UI
                sendSessionStateUpdate(PAUSED, "ACTION_BY_USER");

                document.getElementById('resumeBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
            }

            function resumeSession() {
                if (!mediaSocket || sessionState === STOPPED) {
                    alert('Session is stopped. Please start a new session.');
                    return;
                }

                sessionState = RESUMED;

                if (mediaRecorders.video) mediaRecorders.video.start(100);
                if (mediaRecorders.audio) mediaRecorders.audio.start(100);
                if (recognition) recognition.start();

                // Send state update before modifying UI
                sendSessionStateUpdate(RESUMED, "ACTION_BY_USER");

                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('resumeBtn').disabled = true;
            }

            function stopSession() {
                // Send state update before closing connection
                if (mediaSocket && sessionState !== STOPPED) {
                    sendSessionStateUpdate(STOPPED, "ACTION_BY_USER");
                }

                sessionState = STOPPED;

                // Stop all media streams
                if (recognition) recognition.stop();
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                if (mediaRecorders.video) mediaRecorders.video.stop();
                if (mediaRecorders.audio) mediaRecorders.audio.stop();

                // Reset UI
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('videoContainer').style.display = 'none';

                // Close connection after sending stop message
                if (mediaSocket) {
                    setTimeout(() => {
                        mediaSocket.close();
                        mediaSocket = null;
                        mediaStream = null;
                    }, 100);
                }
            }

            // Enable control buttons after successful connection
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('endBtn').disabled = false;
            document.getElementById('sendBtn').disabled = true;

                    // Add WebSocket close handler
                    if (mediaSocket) {
                        mediaSocket.onclose = () => {
                            console.log('Media connection closed');
                            if (recognition) {
                                recognition.stop();
                            }
                            document.getElementById('sendBtn').disabled = false;
                            document.getElementById('pauseBtn').disabled = true;
                            document.getElementById('resumeBtn').disabled = true;
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('endBtn').disabled = true;
                        };
                    }

                    async function endMeeting() {
                // Send stream termination message
                if (mediaSocket && mediaSocket.readyState === WebSocket.OPEN) {
                    mediaSocket.send(JSON.stringify({
                        msg_type: "SESSION_STATE_UPDATE",
                        session_id: mediaSocket.rtmsSessionId,
                        state: "STOPPED",
                        stop_reason: "ACTION_BY_USER",
                        timestamp: Date.now()
                    }));
                }

                // Reset UI
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('resumeBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('endBtn').disabled = true;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('videoContainer').style.display = 'none';

                // Stop all streams and close connections
                if (recognition) recognition.stop();
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                if (mediaRecorders.video) mediaRecorders.video.stop();
                if (mediaRecorders.audio) mediaRecorders.audio.stop();

                sessionState = "STOPPED";
            }
        </script>
    </body>
</html>