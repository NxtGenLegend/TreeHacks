<!doctype html>
<html>
    <head>
        <title>RTMS Webhook</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 600px;
                margin: 20px auto;
                padding: 20px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            input[type="text"] {
                width: 100%;
                padding: 8px;
                margin-top: 5px;
            }
            button {
                background-color: #0066cc;
                color: white;
                padding: 10px 20px;
                border: none;
                cursor: pointer;
                margin-right: 10px;
            }
            button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }
            button:hover:not(:disabled) {
                background-color: #0052a3;
            }
        </style>
    </head>
    <body>
        <h2>RTMS Webhook Sender</h2>
        <div class="form-group">
            <label>Webhook URL:</label>
            <input
                type="text"
                id="webhookUrl"
                placeholder="Enter webhook URL"
            />
        </div>
        <button onclick="validateWebhook()" id="validateBtn">
            Validate Webhook
        </button>
        <button onclick="sendWebhook()" id="sendBtn" disabled>
            Send Webhook
        </button>
        <div id="videoContainer" style="margin-top: 20px; display: none;">
            <video id="meetingVideo" width="640" height="360" autoplay controls></video>
            <audio id="meetingAudio" autoplay></audio>
        </div>
        <div id="response" style="margin-top: 20px"></div>

        <script>
            let mediaSocket;
            let mediaStream;
            let mediaRecorders = {
                video: null,
                audio: null
            };
            
            async function startMediaStream(serverUrl) {
                const video = document.getElementById('meetingVideo');
                video.style.display = 'block';
                
                try {
                    // Request access to camera and microphone
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true,
                        audio: true 
                    });
                    
                    // Display local video feed
                    video.srcObject = mediaStream;
                    await video.play();
                    
                    mediaSocket = new WebSocket(`${serverUrl}/all`.replace('https://', 'wss://'));
                
                    mediaSocket.onopen = () => {
                        console.log('Connected to media server');
                        document.getElementById('videoContainer').style.display = 'block';
                        
                        // Setup video recorder
                        const videoTrack = mediaStream.getVideoTracks()[0];
                        const videoStream = new MediaStream([videoTrack]);
                        mediaRecorders.video = new MediaRecorder(videoStream, {
                            mimeType: 'video/webm;codecs=vp8'
                        });
                        
                        mediaRecorders.video.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const base64data = reader.result.split(',')[1];
                                    mediaSocket.send(JSON.stringify({
                                        msg_type: "MEDIA_DATA_VIDEO",
                                        content: {
                                            user_id: 0,
                                            data: base64data,
                                            timestamp: Date.now()
                                        }
                                    }));
                                };
                                reader.readAsDataURL(event.data);
                            }
                        };
                        
                        // Setup audio recorder
                        const audioTrack = mediaStream.getAudioTracks()[0];
                        const audioStream = new MediaStream([audioTrack]);
                        mediaRecorders.audio = new MediaRecorder(audioStream, {
                            mimeType: 'audio/webm'
                        });
                        
                        mediaRecorders.audio.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    const base64data = reader.result.split(',')[1];
                                    mediaSocket.send(JSON.stringify({
                                        msg_type: "MEDIA_DATA_AUDIO",
                                        content: {
                                            user_id: 0,
                                            data: base64data,
                                            timestamp: Date.now()
                                        }
                                    }));
                                };
                                reader.readAsDataURL(event.data);
                            }
                        };
                        
                        // Start recording with 100ms intervals
                        mediaRecorders.video.start(100);
                        mediaRecorders.audio.start(100);
                    };

                    mediaSocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        console.log("Received message:", message.msg_type);
                    };
                    
                } catch (err) {
                    console.error("Error accessing media devices:", err);
                }
                        document.getElementById('meetingAudio').src = audioUrl;
                    }
                };
            }
            async function validateWebhook() {
                const webhookUrl = document.getElementById("webhookUrl").value;
                const responseDiv = document.getElementById("response");
                const sendBtn = document.getElementById("sendBtn");

                try {
                    const response = await fetch("/api/validate-webhook", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ webhookUrl }),
                    });

                    const data = await response.json();
                    if (data.success) {
                        responseDiv.innerHTML =
                            "Webhook validated successfully!";
                        sendBtn.disabled = false;
                    } else {
                        responseDiv.innerHTML = `Validation failed: ${data.error}`;
                        sendBtn.disabled = true;
                    }
                } catch (error) {
                    responseDiv.innerHTML = `Error: ${error.message}`;
                    sendBtn.disabled = true;
                }
            }

            async function sendWebhook() {
                const webhookUrl = document.getElementById("webhookUrl").value;
                const responseDiv = document.getElementById("response");
                
                try {
                    const response = await fetch("/api/send-webhook", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ webhookUrl }),
                    });

                    const data = await response.json();
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    
                    // Start media stream after successful webhook
                    if (data.success && data.sent.payload.payload.object.server_urls) {
                        startMediaStream(data.sent.payload.payload.object.server_urls);
                    }
                } catch (error) {
                    responseDiv.innerHTML = `Error: ${error.message}`;
                }
            }
        </script>
    </body>
</html>
